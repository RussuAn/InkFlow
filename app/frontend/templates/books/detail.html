{% extends "base.html" %}

{% block title %}{{ book.title }} | InkFlow{% endblock %}

{% block content %}
<div style="padding: 2rem 0; max-width: 1000px; margin: 0 auto;">
    
    <div style="display: flex; gap: 3rem; flex-wrap: wrap; margin-bottom: 4rem;">
        
        <div style="flex: 1; min-width: 280px; max-width: 350px;">
            
            <div style="aspect-ratio: 2/3; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 1.5rem; position: relative;">
                <img src="{{ url_for('static', filename='uploads/covers/' + book.cover_image) }}" 
                     alt="{{ book.title }}" 
                     style="width: 100%; height: 100%; object-fit: cover;">
                
                <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; backdrop-filter: blur(4px);">
                    {% if book.price_coins == 0 %}Free{% else %}{{ book.price_coins }} ü™ô{% endif %}
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 2rem;">
                
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('reader.read_book', book_id=book.id) }}" 
                       style="display: block; text-align: center; width: 100%; padding: 14px; background: var(--text-main); color: var(--bg-body); border: none; border-radius: 30px; font-weight: 600; font-size: 1rem; cursor: pointer; text-decoration: none; transition: opacity 0.2s;">
                       üìñ –ß–∏—Ç–∞—Ç–∏ –æ–Ω–ª–∞–π–Ω
                    </a>
                {% else %}
                    <a href="{{ url_for('auth.login', next=request.path) }}" 
                       style="display: block; text-align: center; width: 100%; padding: 14px; background: var(--text-main); color: var(--bg-body); border: none; border-radius: 30px; font-weight: 600; font-size: 1rem; cursor: pointer; text-decoration: none;">
                       –£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± —á–∏—Ç–∞—Ç–∏
                    </a>
                {% endif %}
                
                {% if is_purchased or book.price_coins == 0 %}
                    <a href="{{ url_for('static', filename='uploads/books/' + book.file_path) }}" download 
                       style="display: block; text-align: center; width: 100%; padding: 14px; background: transparent; border: 2px solid var(--text-main); color: var(--text-main); border-radius: 30px; font-weight: 600; text-decoration: none; transition: background 0.2s;">
                        ‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
                    </a>
                {% else %}
                    <a href="{{ url_for('books.buy_book_route', book_id=book.id) }}" 
                       style="display: block; text-align: center; text-decoration: none; width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 30px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        –ö—É–ø–∏—Ç–∏ –∑–∞ {{ book.price_coins }} ü™ô
                    </a>

                    <button onclick="openGiftModal()" 
                            style="width: 100%; padding: 12px; background: transparent; border: 2px solid var(--accent); color: var(--accent); border-radius: 30px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;">
                        üéÅ –ü–æ–¥–∞—Ä—É–≤–∞—Ç–∏ –¥—Ä—É–≥—É
                    </button>
                {% endif %}
            </div>

            {% if current_user.is_authenticated %}
            <div style="padding-top: 1.5rem; border-top: 1px solid var(--border);">
                <p style="margin-bottom: 1rem; font-weight: 600; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">–î–æ–¥–∞—Ç–∏ –Ω–∞ –ø–æ–ª–∏—Ü—é</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <a href="{{ url_for('library.update_status', book_id=book.id, status='planned') }}" class="shelf-btn {% if current_status == 'planned' %}active{% endif %}">üìÖ –í –ø–ª–∞–Ω–∞—Ö</a>
                    <a href="{{ url_for('library.update_status', book_id=book.id, status='reading') }}" class="shelf-btn {% if current_status == 'reading' %}active{% endif %}">üìñ –ß–∏—Ç–∞—é</a>
                    <a href="{{ url_for('library.update_status', book_id=book.id, status='completed') }}" class="shelf-btn {% if current_status == 'completed' %}active{% endif %}">‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</a>
                    <a href="{{ url_for('library.update_status', book_id=book.id, status='dropped') }}" class="shelf-btn {% if current_status == 'dropped' %}active{% endif %}">‚ùå –ö–∏–Ω—É–≤</a>
                </div>
            </div>
            {% endif %}
        </div>

        <div style="flex: 2; min-width: 300px;">
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; line-height: 1.2;">{{ book.title }}</h1>
            
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                <a href="{{ url_for('books.search', q=book.author) }}" style="text-decoration: none;">
                    <h3 style="font-size: 1.2rem; color: var(--accent); font-weight: 500; margin: 0;">{{ book.author }}</h3>
                </a>
                <span style="color: var(--border);">|</span>
                {% if book.genre %}
                    <a href="{{ url_for('books.search', q=book.genre) }}" 
                       style="background: var(--bg-body); border: 1px solid var(--border); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); text-decoration: none; transition: all 0.2s;"
                       onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'"
                       onmouseout="this.style.borderColor='var(--border)'; this.style.color='var(--text-muted)'">
                        {{ book.genre }}
                    </a>
                    <span style="color: var(--border);">|</span>
                {% endif %}
                <span style="color: var(--text-muted); font-size: 0.9rem;">‚≠ê {{ reviews|length }} –≤—ñ–¥–≥—É–∫—ñ–≤</span>
            </div>
            
            <div style="background: var(--bg-card); padding: 2.5rem; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1.5rem; font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1.5px; font-weight: 700;">–ê–Ω–æ—Ç–∞—Ü—ñ—è</h4>
                <p style="line-height: 1.8; color: var(--text-main); white-space: pre-line; font-size: 1.05rem;">{{ book.description }}</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-card);">
                <div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px;">–ú–æ–≤–∞</div>
                    <div style="font-weight: 600;">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ üá∫üá¶</div>
                </div>
                <div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px;">–§–æ—Ä–º–∞—Ç</div>
                    <div style="font-weight: 600;">PDF / EPUB</div>
                </div>
                <div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px;">–î–∞—Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è</div>
                    <div style="font-weight: 600;">{{ book.created_at.strftime('%d.%m.%Y') if book.created_at else '–ù–µ–≤—ñ–¥–æ–º–æ' }}</div>
                </div>
                <div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px;">–ü–µ—Ä–µ–≥–ª—è–¥—ñ–≤</div>
                    <div style="font-weight: 600;">{{ book.views_count }}</div>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border);">
        <h3 style="margin-bottom: 2rem; font-size: 1.5rem;">–í—ñ–¥–≥—É–∫–∏ —á–∏—Ç–∞—á—ñ–≤ <span style="color: var(--text-muted); font-size: 1rem; margin-left: 10px;">({{ reviews|length }})</span></h3>

        {% if current_user.is_authenticated %}
        <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; margin-bottom: 3rem; box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h4 style="margin-bottom: 1rem;">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h4>
            <form method="POST">
                {{ form.hidden_tag() }}
                <div style="display: grid; gap: 1rem;">
                    <div>
                        {{ form.rating.label(style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;") }}
                        {{ form.rating(style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-size: 1rem;") }}
                    </div>
                    <div>
                        {{ form.comment(style="width: 100%; min-height: 100px; padding: 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-family: inherit; font-size: 1rem; resize: vertical;", placeholder="–©–æ –≤–∞–º —Å–ø–æ–¥–æ–±–∞–ª–æ—Å—å, –∞ —â–æ –Ω—ñ?") }}
                    </div>
                    <div>
                        {{ form.submit(style="background: var(--text-main); color: var(--bg-body); padding: 10px 30px; border: none; border-radius: 30px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: opacity 0.2s;") }}
                    </div>
                </div>
            </form>
        </div>
        {% else %}
            <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 3rem; border: 1px dashed var(--border);">
                <p style="color: var(--text-muted); margin-bottom: 1rem;">–•–æ—á–µ—Ç–µ –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è –¥—É–º–∫–æ—é?</p>
                <a href="{{ url_for('auth.login', next=request.path) }}" style="display: inline-block; background: var(--accent); color: white; padding: 10px 25px; border-radius: 30px; text-decoration: none; font-weight: 600;">–£–≤—ñ–π—Ç–∏, —â–æ–± –∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏</a>
            </div>
        {% endif %}

        <div style="display: flex; flex-direction: column; gap: 2rem;">
            {% for review in reviews %}
            <div style="display: flex; gap: 1.5rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border);">
                <div style="flex-shrink: 0;">
                    {% if review.avatar_url %}
                        <img src="{{ url_for('static', filename='uploads/avatars/' + review.avatar_url) }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ review.username }}&background=random" style="width: 50px; height: 50px; border-radius: 50%;">
                    {% endif %}
                </div>
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem; flex-wrap: wrap;">
                        <div>
                            <span style="font-weight: 700; font-size: 1.1rem; margin-right: 10px;">{{ review.display_name or review.username }}</span>
                            <span style="font-size: 0.85rem; color: var(--text-muted);">@{{ review.username }}</span>
                        </div>
                        <span style="color: #f1c40f; font-size: 0.9rem;">{% for _ in range(review.rating) %}‚≠ê{% endfor %}</span>
                    </div>
                    <p style="color: var(--text-main); line-height: 1.6; margin-bottom: 0.5rem;">{{ review.comment }}</p>
                    <p style="color: var(--text-muted); font-size: 0.8rem;">{{ review.created_at.strftime('%d.%m.%Y') }}</p>
                </div>
            </div>
            {% else %}
                <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                    <p style="font-size: 3rem; margin-bottom: 1rem;">üí≠</p>
                    <p>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤.</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="gift-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeGiftModal()">&times;</button>
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéÅ</div>
            <h3 style="margin: 0;">–ó—Ä–æ–±–∏—Ç–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem;">–ü–æ–¥–∞—Ä—É–π—Ç–µ –∫–Ω–∏–≥—É "{{ book.title }}"</p>
        </div>
        <form action="{{ url_for('books.gift_book_route', book_id=book.id) }}" method="POST">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ù—ñ–∫–Ω–µ–π–º –¥—Ä—É–≥–∞</label>
                <div style="position: relative;">
                    <span style="position: absolute; left: 12px; top: 11px; color: var(--text-muted);">@</span>
                    <input type="text" name="recipient_username" placeholder="username" required style="width: 100%; padding: 10px 10px 10px 30px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-size: 1rem;">
                </div>
            </div>
            <div style="background: var(--bg-body); padding: 10px; border-radius: 8px; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem; text-align: center;">
                –ó –≤–∞—à–æ–≥–æ –±–∞–ª–∞–Ω—Å—É –±—É–¥–µ —Å–ø–∏—Å–∞–Ω–æ <strong>{{ book.price_coins }} ü™ô</strong>
            </div>
            <button type="submit" style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 30px; font-weight: 600; cursor: pointer;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫</button>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('gift-modal');
    function openGiftModal() { modal.classList.add('active'); }
    function closeGiftModal() { modal.classList.remove('active'); }
    modal.addEventListener('click', (e) => { if (e.target === modal) closeGiftModal(); });
</script>
{% endblock %}